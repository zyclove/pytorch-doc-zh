
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Writing Distributed Applications with PyTorch · Pytorch 中文文档</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="ApacheCN">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-insert-logo/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-pageview-count/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-emphasize/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-alerts/style.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-auto-scroll-table/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-advanced-emoji/emoji-website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="spatial_transformer_tutorial.html" />
    
    
    <link rel="prev" href="reinforcement_q_learning.html" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"buttons":[{"user":"apachecn","repo":"pytorch-doc-zh","type":"star","count":true,"size":"small"}]};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    PyTorch 0.3 中文文档 & 教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="tut.html">
            
                <a href="tut.html">
            
                    
                    中文教程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="beginner_tutorials.html">
            
                <a href="beginner_tutorials.html">
            
                    
                    初学者教程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="deep_learning_60min_blitz.html">
            
                <a href="deep_learning_60min_blitz.html">
            
                    
                    PyTorch 深度学习: 60 分钟极速入门教程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1.1" data-path="blitz_tensor_tutorial.html">
            
                <a href="blitz_tensor_tutorial.html">
            
                    
                    PyTorch 是什么？
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.1.2" data-path="blitz_autograd_tutorial.html">
            
                <a href="blitz_autograd_tutorial.html">
            
                    
                    自动求导: 自动微分
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.1.3" data-path="blitz_neural_networks_tutorial.html">
            
                <a href="blitz_neural_networks_tutorial.html">
            
                    
                    神经网络
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.1.4" data-path="blitz_cifar10_tutorial.html">
            
                <a href="blitz_cifar10_tutorial.html">
            
                    
                    训练一个分类器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.1.5" data-path="blitz_data_parallel_tutorial.html">
            
                <a href="blitz_data_parallel_tutorial.html">
            
                    
                    可选: 数据并行
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="former_torchies_tutorial.html">
            
                <a href="former_torchies_tutorial.html">
            
                    
                    PyTorch for former Torch users
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.2.1" data-path="former_torchies_tensor_tutorial.html">
            
                <a href="former_torchies_tensor_tutorial.html">
            
                    
                    Tensors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2.2" data-path="former_torchies_autograd_tutorial.html">
            
                <a href="former_torchies_autograd_tutorial.html">
            
                    
                    Autograd (自动求导)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2.3" data-path="former_torchies_nn_tutorial.html">
            
                <a href="former_torchies_nn_tutorial.html">
            
                    
                    nn package
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2.4" data-path="former_torchies_parallelism_tutorial.html">
            
                <a href="former_torchies_parallelism_tutorial.html">
            
                    
                    Multi-GPU examples
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.1.3" data-path="pytorch_with_examples.html">
            
                <a href="pytorch_with_examples.html">
            
                    
                    跟着例子学习 PyTorch
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.3.1" data-path="pytorch_with_examples_warm-up-numpy.html">
            
                <a href="pytorch_with_examples_warm-up-numpy.html">
            
                    
                    Warm-up: numpy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.2" data-path="pytorch_with_examples_pytorch-tensors.html">
            
                <a href="pytorch_with_examples_pytorch-tensors.html">
            
                    
                    PyTorch: Tensors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.3" data-path="pytorch_with_examples_pytorch-variables-and-autograd.html">
            
                <a href="pytorch_with_examples_pytorch-variables-and-autograd.html">
            
                    
                    PyTorch: 变量和autograd
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.4" data-path="pytorch_with_examples_pytorch-defining-new-autograd-functions.html">
            
                <a href="pytorch_with_examples_pytorch-defining-new-autograd-functions.html">
            
                    
                    PyTorch: 定义新的autograd函数
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.5" data-path="pytorch_with_examples_tensorflow-static-graphs.html">
            
                <a href="pytorch_with_examples_tensorflow-static-graphs.html">
            
                    
                    TensorFlow: 静态图
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.6" data-path="pytorch_with_examples_pytorch-nn.html">
            
                <a href="pytorch_with_examples_pytorch-nn.html">
            
                    
                    PyTorch: nn包
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.7" data-path="pytorch_with_examples_pytorch-optim.html">
            
                <a href="pytorch_with_examples_pytorch-optim.html">
            
                    
                    PyTorch: optim包
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.8" data-path="pytorch_with_examples_pytorch-custom-nn-modules.html">
            
                <a href="pytorch_with_examples_pytorch-custom-nn-modules.html">
            
                    
                    PyTorch: 定制化nn模块
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3.9" data-path="pytorch_with_examples_pytorch-control-flow-weight-sharing.html">
            
                <a href="pytorch_with_examples_pytorch-control-flow-weight-sharing.html">
            
                    
                    PyTorch: 动态控制流程 + 权重共享
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.1.4" data-path="transfer_learning_tutorial.html">
            
                <a href="transfer_learning_tutorial.html">
            
                    
                    迁移学习教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.5" data-path="data_loading_tutorial.html">
            
                <a href="data_loading_tutorial.html">
            
                    
                    数据加载和处理教程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.6" data-path="deep_learning_nlp_tutorial.html">
            
                <a href="deep_learning_nlp_tutorial.html">
            
                    
                    针对NLP的Pytorch深度学习
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.6.1" data-path="nlp_pytorch_tutorial.html">
            
                <a href="nlp_pytorch_tutorial.html">
            
                    
                    PyTorch介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.6.2" data-path="nlp_deep_learning_tutorial.html">
            
                <a href="nlp_deep_learning_tutorial.html">
            
                    
                    PyTorch深度学习
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.6.3" data-path="nlp_word_embeddings_tutorial.html">
            
                <a href="nlp_word_embeddings_tutorial.html">
            
                    
                    词汇嵌入:编码词汇语义
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.6.4" data-path="nlp_sequence_models_tutorial.html">
            
                <a href="nlp_sequence_models_tutorial.html">
            
                    
                    序列模型和 LSTM 网络（长短记忆网络）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.6.5" data-path="nlp_advanced_tutorial.html">
            
                <a href="nlp_advanced_tutorial.html">
            
                    
                    高级教程: 作出动态决策和 Bi-LSTM CRF
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="intermediate_tutorials.html">
            
                <a href="intermediate_tutorials.html">
            
                    
                    中级教程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="char_rnn_classification_tutorial.html">
            
                <a href="char_rnn_classification_tutorial.html">
            
                    
                    用字符级RNN分类名称
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="char_rnn_generation_tutorial.html">
            
                <a href="char_rnn_generation_tutorial.html">
            
                    
                    基与字符级RNN（Char-RNN）的人名生成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3" data-path="seq2seq_translation_tutorial.html">
            
                <a href="seq2seq_translation_tutorial.html">
            
                    
                    用基于注意力机制的seq2seq神经网络进行翻译
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.4" data-path="reinforcement_q_learning.html">
            
                <a href="reinforcement_q_learning.html">
            
                    
                    强化学习（DQN）教程
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.2.5" data-path="dist_tuto.html">
            
                <a href="dist_tuto.html">
            
                    
                    Writing Distributed Applications with PyTorch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.6" data-path="spatial_transformer_tutorial.html">
            
                <a href="spatial_transformer_tutorial.html">
            
                    
                    空间转换网络 (Spatial Transformer Networks) 教程
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="advanced_tutorials.html">
            
                <a href="advanced_tutorials.html">
            
                    
                    高级教程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.3.1" data-path="neural_style_tutorial.html">
            
                <a href="neural_style_tutorial.html">
            
                    
                    用 PyTorch 做 神经转换 (Neural Transfer)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.2" data-path="numpy_extensions_tutorial.html">
            
                <a href="numpy_extensions_tutorial.html">
            
                    
                    使用 numpy 和 scipy 创建扩展
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.3" data-path="super_resolution_with_caffe2.html">
            
                <a href="super_resolution_with_caffe2.html">
            
                    
                    使用 ONNX 将模型从 PyTorch 迁移到 Caffe2 和 Mobile
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.4" data-path="c_extension.html">
            
                <a href="c_extension.html">
            
                    
                    为 pytorch 自定义 C 扩展
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="doc.html">
            
                <a href="doc.html">
            
                    
                    中文文档
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="notes.html">
            
                <a href="notes.html">
            
                    
                    介绍
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="notes_autograd.html">
            
                <a href="notes_autograd.html">
            
                    
                    自动求导机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="notes_broadcasting.html">
            
                <a href="notes_broadcasting.html">
            
                    
                    广播语义
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.3" data-path="notes_cuda.html">
            
                <a href="notes_cuda.html">
            
                    
                    CUDA 语义
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.4" data-path="notes_extending.html">
            
                <a href="notes_extending.html">
            
                    
                    扩展 PyTorch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.5" data-path="notes_multiprocessing.html">
            
                <a href="notes_multiprocessing.html">
            
                    
                    多进程的最佳实践
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.6" data-path="notes_serialization.html">
            
                <a href="notes_serialization.html">
            
                    
                    序列化语义
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="package_reference.html">
            
                <a href="package_reference.html">
            
                    
                    Package 参考
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="torch.html">
            
                <a href="torch.html">
            
                    
                    torch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="tensors.html">
            
                <a href="tensors.html">
            
                    
                    torch.Tensor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.3" data-path="sparse.html">
            
                <a href="sparse.html">
            
                    
                    torch.sparse
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.4" data-path="storage.html">
            
                <a href="storage.html">
            
                    
                    torch.Storage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.5" data-path="nn.html">
            
                <a href="nn.html">
            
                    
                    torch.nn
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.6" data-path="optim.html">
            
                <a href="optim.html">
            
                    
                    torch.optim
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.7" data-path="autograd.html">
            
                <a href="autograd.html">
            
                    
                    Automatic differentiation package - torch.autograd
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.8" data-path="distributions.html">
            
                <a href="distributions.html">
            
                    
                    Probability distributions - torch.distributions
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.9" data-path="multiprocessing.html">
            
                <a href="multiprocessing.html">
            
                    
                    Multiprocessing package - torch.multiprocessing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.10" data-path="distributed.html">
            
                <a href="distributed.html">
            
                    
                    Distributed communication package - torch.distributed
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.11" data-path="legacy.html">
            
                <a href="legacy.html">
            
                    
                    Legacy package - torch.legacy
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.12" data-path="cuda.html">
            
                <a href="cuda.html">
            
                    
                    torch.cuda
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.13" data-path="ffi.html">
            
                <a href="ffi.html">
            
                    
                    torch.utils.ffi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.14" data-path="data.html">
            
                <a href="data.html">
            
                    
                    torch.utils.data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.15" data-path="model_zoo.html">
            
                <a href="model_zoo.html">
            
                    
                    torch.utils.model_zoo
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.16" data-path="onnx.html">
            
                <a href="onnx.html">
            
                    
                    torch.onnx
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="torchvision_reference.html">
            
                <a href="torchvision_reference.html">
            
                    
                    torchvision 参考
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.3.1" data-path="torchvision.html">
            
                <a href="torchvision.html">
            
                    
                    torchvision
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.2" data-path="datasets.html">
            
                <a href="datasets.html">
            
                    
                    torchvision.datasets
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.3" data-path="models.html">
            
                <a href="models.html">
            
                    
                    torchvision.models
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.4" data-path="transforms.html">
            
                <a href="transforms.html">
            
                    
                    torchvision.transforms
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3.5" data-path="utils.html">
            
                <a href="utils.html">
            
                    
                    torchvision.utils
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Writing Distributed Applications with PyTorch</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="writing-distributed-applications-with-pytorch">Writing Distributed Applications with PyTorch</h1>
<blockquote>
<p>&#x8BD1;&#x8005;&#xFF1A;<a href="https://github.com/coboe" target="_blank">@Sylvester</a></p>
</blockquote>
<p><strong>Author</strong>: <a href="http://seba1511.com" target="_blank">S&#xE9;b Arnold</a></p>
<p>In this short tutorial, we will be going over the distributed package of PyTorch. We&#x2019;ll see how to set up the distributed setting, use the different communication strategies, and go over some the internals of the package.</p>
<h2 id="setup">Setup</h2>
<p>The distributed package included in PyTorch (i.e., <code>torch.distributed</code>) enables researchers and practitioners to easily parallelize their computations across processes and clusters of machines. To do so, it leverages the messaging passing semantics allowing each process to communicate data to any of the other processes. As opposed to the multiprocessing (<code>torch.multiprocessing</code>) package, processes can use different communication backends and are not restricted to being executed on the same machine.</p>
<p>In order to get started we need the ability to run multiple processes simultaneously. If you have access to compute cluster you should check with your local sysadmin or use your favorite coordination tool. (e.g., <a href="https://linux.die.net/man/1/pdsh" target="_blank">pdsh</a>, <a href="http://cea-hpc.github.io/clustershell/" target="_blank">clustershell</a>, or <a href="https://slurm.schedmd.com/" target="_blank">others</a>) For the purpose of this tutorial, we will use a single machine and fork multiple processes using the following template.</p>
<pre><code class="lang-py"><span class="hljs-string">&quot;&quot;&quot;run.py:&quot;&quot;&quot;</span>
<span class="hljs-comment">#!/usr/bin/env python</span>
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> torch.distributed <span class="hljs-keyword">as</span> dist
<span class="hljs-keyword">from</span> torch.multiprocessing <span class="hljs-keyword">import</span> Process

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(rank, size)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot; Distributed function to be implemented later. &quot;&quot;&quot;</span>
    <span class="hljs-keyword">pass</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_processes</span><span class="hljs-params">(rank, size, fn, backend=<span class="hljs-string">&apos;tcp&apos;</span>)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot; Initialize the distributed environment. &quot;&quot;&quot;</span>
    os.environ[<span class="hljs-string">&apos;MASTER_ADDR&apos;</span>] = <span class="hljs-string">&apos;127.0.0.1&apos;</span>
    os.environ[<span class="hljs-string">&apos;MASTER_PORT&apos;</span>] = <span class="hljs-string">&apos;29500&apos;</span>
    dist.init_process_group(backend, rank=rank, world_size=size)
    fn(rank, size)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:
    size = <span class="hljs-number">2</span>
    processes = []
    <span class="hljs-keyword">for</span> rank <span class="hljs-keyword">in</span> range(size):
        p = Process(target=init_processes, args=(rank, size, run))
        p.start()
        processes.append(p)

    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> processes:
        p.join()
</code></pre>
<p>The above script spawns two processes who will each setup the distributed environment, initialize the process group (<code>dist.init_process_group</code>), and finally execute the given <code>run</code> function.</p>
<p>Let&#x2019;s have a look at the <code>init_processes</code> function. It ensures that every process will be able to coordinate through a master, using the same ip address and port. Note that we used the TCP backend, but we could have used MPI](<a href="https://en.wikipedia.org/wiki/Message_Passing_Interface" target="_blank">https://en.wikipedia.org/wiki/Message_Passing_Interface</a>) or <a href="http://github.com/facebookincubator/gloo" target="_blank">Gloo</a> instead. (c.f. [Section 5.1) We will go over the magic happening in <code>dist.init_process_group</code> at the end of this tutorial, but it essentially allows processes to communicate with each other by sharing their locations.</p>
<h2 id="point-to-point-communication">Point-to-Point Communication</h2>
<p><a href="http://pytorch.apachecn.org/cn/tutorials/_images/send_recv.png" target="_blank"><img src="img/d272e50143a78046107f9ff8bc6de612.jpg" alt="Send and Recv"></a></p>
<p>Send and Recv</p>
<p>A transfer of data from one process to another is called a point-to-point communication. These are achieved through the <code>send</code> and <code>recv</code> functions or their <em>immediate</em> counter-parts, <code>isend</code> and <code>irecv</code>.</p>
<pre><code class="lang-py"><span class="hljs-string">&quot;&quot;&quot;Blocking point-to-point communication.&quot;&quot;&quot;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(rank, size)</span>:</span>
    tensor = torch.zeros(<span class="hljs-number">1</span>)
    <span class="hljs-keyword">if</span> rank == <span class="hljs-number">0</span>:
        tensor += <span class="hljs-number">1</span>
        <span class="hljs-comment"># Send the tensor to process 1</span>
        dist.send(tensor=tensor, dst=<span class="hljs-number">1</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># Receive tensor from process 0</span>
        dist.recv(tensor=tensor, src=<span class="hljs-number">0</span>)
    print(<span class="hljs-string">&apos;Rank &apos;</span>, rank, <span class="hljs-string">&apos; has data &apos;</span>, tensor[<span class="hljs-number">0</span>])
</code></pre>
<p>In the above example, both processes start with a zero tensor, then process 0 increments the tensor and sends it to process 1 so that they both end up with 1.0. Notice that process 1 needs to allocate memory in order to store the data it will receive.</p>
<p>Also notice that <code>send</code>/<code>recv</code> are <strong>blocking</strong>: both processes stop until the communication is completed. On the other hand immediates are <strong>non-blocking</strong>; the script continues its execution and the methods return a <code>DistributedRequest</code> object upon which we can choose to <code>wait()</code>.</p>
<pre><code class="lang-py"><span class="hljs-string">&quot;&quot;&quot;Non-blocking point-to-point communication.&quot;&quot;&quot;</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(rank, size)</span>:</span>
    tensor = torch.zeros(<span class="hljs-number">1</span>)
    req = <span class="hljs-keyword">None</span>
    <span class="hljs-keyword">if</span> rank == <span class="hljs-number">0</span>:
        tensor += <span class="hljs-number">1</span>
        <span class="hljs-comment"># Send the tensor to process 1</span>
        req = dist.isend(tensor=tensor, dst=<span class="hljs-number">1</span>)
        print(<span class="hljs-string">&apos;Rank 0 started sending&apos;</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># Receive tensor from process 0</span>
        req = dist.irecv(tensor=tensor, src=<span class="hljs-number">0</span>)
        print(<span class="hljs-string">&apos;Rank 1 started receiving&apos;</span>)
    req.wait()
    print(<span class="hljs-string">&apos;Rank &apos;</span>, rank, <span class="hljs-string">&apos; has data &apos;</span>, tensor[<span class="hljs-number">0</span>])
</code></pre>
<p>When using immediates we have to be careful about with our usage of the sent and received tensors. Since we do not know when the data will be communicated to the other process, we should not modify the sent tensor nor access the received tensor before <code>req.wait()</code> has completed. In other words,</p>
<ul>
<li>writing to <code>tensor</code> after <code>dist.isend()</code> will result in undefined behaviour.</li>
<li>reading from <code>tensor</code> after <code>dist.irecv()</code> will result in undefined behaviour.</li>
</ul>
<p>However, after <code>req.wait()</code> has been executed we are guaranteed that the communication took place, and that the value stored in <code>tensor[0]</code> is 1.0.</p>
<p>Point-to-point communication is useful when we want a fine-grained control over the communication of our processes. They can be used to implement fancy algorithms, such as the one used in Baidu&#x2019;s DeepSpeech](<a href="https://github.com/baidu-research/baidu-allreduce" target="_blank">https://github.com/baidu-research/baidu-allreduce</a>) or <a href="https://research.fb.com/publications/imagenet1kin1h/" target="_blank">Facebook&#x2019;s large-scale experiments</a>.(c.f. [Section 4.1)</p>
<h2 id="collective-communication">Collective Communication</h2>
<p>| <a href="http://pytorch.apachecn.org/cn/tutorials/_images/scatter.png" target="_blank"><img src="img/9604889913cb38d8a12cc4b86ae3987a.jpg" alt="Scatter"></a></p>
<p>Scatter</p>
<p> | <a href="http://pytorch.apachecn.org/cn/tutorials/_images/gather.png" target="_blank"><img src="img/1eaf8e073bae07dc68de94f3277b4855.jpg" alt="Gather"></a></p>
<p>Gather</p>
<p> |
| <a href="http://pytorch.apachecn.org/cn/tutorials/_images/reduce.png" target="_blank"><img src="img/bc5c32aa37249bae805767e5f8010ab5.jpg" alt="Reduce"></a></p>
<p>Reduce</p>
<p> | <a href="http://pytorch.apachecn.org/cn/tutorials/_images/all_reduce.png" target="_blank"><img src="img/2d539c22f0f4a1730aa475b64cb5c216.jpg" alt="All-Reduce"></a></p>
<p>All-Reduce</p>
<p> |
| <a href="http://pytorch.apachecn.org/cn/tutorials/_images/broadcast.png" target="_blank"><img src="img/46331a7401d267cc68c92b76d3a20b19.jpg" alt="Broadcast"></a></p>
<p>Broadcast</p>
<p> | <a href="http://pytorch.apachecn.org/cn/tutorials/_images/all_gather.png" target="_blank"><img src="img/750dd2f358e9c7105326f7c5f1fc6f80.jpg" alt="All-Gather"></a></p>
<p>All-Gather</p>
<p> |</p>
<p>As opposed to point-to-point communcation, collectives allow for communication patterns across all processes in a <strong>group</strong>. A group is a subset of all our processes. To create a group, we can pass a list of ranks to <code>dist.new_group(group)</code>. By default, collectives are executed on the all processes, also known as the <strong>world</strong>. For example, in order to obtain the sum of all tensors at all processes, we can use the <code>dist.all_reduce(tensor, op, group)</code> collective.</p>
<pre><code class="lang-py"><span class="hljs-string">&quot;&quot;&quot; All-Reduce example.&quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(rank, size)</span>:</span>
    <span class="hljs-string">&quot;&quot;&quot; Simple point-to-point communication. &quot;&quot;&quot;</span>
    group = dist.new_group([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>])
    tensor = torch.ones(<span class="hljs-number">1</span>)
    dist.all_reduce(tensor, op=dist.reduce_op.SUM, group=group)
    print(<span class="hljs-string">&apos;Rank &apos;</span>, rank, <span class="hljs-string">&apos; has data &apos;</span>, tensor[<span class="hljs-number">0</span>])
</code></pre>
<p>Since we want the sum of all tensors in the group, we use <code>dist.reduce_op.SUM</code> as the reduce operator. Generally speaking, any commutative mathematical operation can be used as an operator. Out-of-the-box, PyTorch comes with 4 such operators, all working at the element-wise level:</p>
<ul>
<li><code>dist.reduce_op.SUM</code>,</li>
<li><code>dist.reduce_op.PRODUCT</code>,</li>
<li><code>dist.reduce_op.MAX</code>,</li>
<li><code>dist.reduce_op.MIN</code>.</li>
</ul>
<p>In addition to <code>dist.all_reduce(tensor, op, group)</code>, there are a total of 6 collectives currently implemented in PyTorch.</p>
<ul>
<li><code>dist.broadcast(tensor, src, group)</code>: Copies <code>tensor</code> from <code>src</code> to all other processes.</li>
<li><code>dist.reduce(tensor, dst, op, group)</code>: Applies <code>op</code> to all <code>tensor</code> and stores the result in <code>dst</code>.</li>
<li><code>dist.all_reduce(tensor, op, group)</code>: Same as reduce, but the result is stored in all processes.</li>
<li><code>dist.scatter(tensor, src, scatter_list, group)</code>: Copies the <img src="img/tex-3c6f9d03598605efb1686c6a5c655f3d.gif" alt="i^{\text{th}}"> tensor <code>scatter_list[i]</code> to the <img src="img/tex-3c6f9d03598605efb1686c6a5c655f3d.gif" alt="i^{\text{th}}"> process.</li>
<li><code>dist.gather(tensor, dst, gather_list, group)</code>: Copies <code>tensor</code> from all processes in <code>dst</code>.</li>
<li><code>dist.all_gather(tensor_list, tensor, group)</code>: Copies <code>tensor</code> from all processes to <code>tensor_list</code>, on all processes.</li>
</ul>
<h2 id="distributed-training">Distributed Training</h2>
<p><strong>Note:</strong> You can find the example script of this section in <a href="https://github.com/seba-1511/dist_tuto.pth/" target="_blank">this GitHub repository</a>.</p>
<p>Now that we understand how the distributed module works, let us write something useful with it. Our goal will be to replicate the functionality of <a href="https://pytorch.org/docs/master/nn.html#torch.nn.parallel.DistributedDataParallel" target="_blank">DistributedDataParallel</a>. Of course, this will be a didactic example and in a real-world situtation you should use the official, well-tested and well-optimized version linked above.</p>
<p>Quite simply we want to implement a distributed version of stochastic gradient descent. Our script will let all processes compute the gradients of their model on their batch of data and then average their gradients. In order to ensure similar convergence results when changing the number of processes, we will first have to partition our dataset. (You could also use <a href="https://github.com/pytorch/tnt/blob/master/torchnet/dataset/splitdataset.py#L4" target="_blank">tnt.dataset.SplitDataset</a>, instead of the snippet below.)</p>
<pre><code class="lang-py"><span class="hljs-string">&quot;&quot;&quot; Dataset partitioning helper &quot;&quot;&quot;</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Partition</span><span class="hljs-params">(object)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, data, index)</span>:</span>
        self.data = data
        self.index = index

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__len__</span><span class="hljs-params">(self)</span>:</span>
        <span class="hljs-keyword">return</span> len(self.index)

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__getitem__</span><span class="hljs-params">(self, index)</span>:</span>
        data_idx = self.index[index]
        <span class="hljs-keyword">return</span> self.data[data_idx]

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DataPartitioner</span><span class="hljs-params">(object)</span>:</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, data, sizes=[<span class="hljs-number">0.7</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.1</span>], seed=<span class="hljs-number">1234</span>)</span>:</span>
        self.data = data
        self.partitions = []
        rng = Random()
        rng.seed(seed)
        data_len = len(data)
        indexes = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, data_len)]
        rng.shuffle(indexes)

        <span class="hljs-keyword">for</span> frac <span class="hljs-keyword">in</span> sizes:
            part_len = int(frac * data_len)
            self.partitions.append(indexes[<span class="hljs-number">0</span>:part_len])
            indexes = indexes[part_len:]

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">use</span><span class="hljs-params">(self, partition)</span>:</span>
        <span class="hljs-keyword">return</span> Partition(self.data, self.partitions[partition])
</code></pre>
<p>With the above snippet, we can now simply partition any dataset using the following few lines:</p>
<pre><code class="lang-py"><span class="hljs-string">&quot;&quot;&quot; Partitioning MNIST &quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">partition_dataset</span><span class="hljs-params">()</span>:</span>
    dataset = datasets.MNIST(<span class="hljs-string">&apos;./data&apos;</span>, train=<span class="hljs-keyword">True</span>, download=<span class="hljs-keyword">True</span>,
                             transform=transforms.Compose([
                                 transforms.ToTensor(),
                                 transforms.Normalize((<span class="hljs-number">0.1307</span>,), (<span class="hljs-number">0.3081</span>,))
                             ]))
    size = dist.get_world_size()
    bsz = <span class="hljs-number">128</span> / float(size)
    partition_sizes = [<span class="hljs-number">1.0</span> / size <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> range(size)]
    partition = DataPartitioner(dataset, partition_sizes)
    partition = partition.use(dist.get_rank())
    train_set = torch.utils.data.DataLoader(partition,
                                         batch_size=bsz,
                                         shuffle=<span class="hljs-keyword">True</span>)
    <span class="hljs-keyword">return</span> train_set, bsz
</code></pre>
<p>Assuming we have 2 replicas, then each process will have a <code>train_set</code> of 60000 / 2 = 30000 samples. We also divide the batch size by the number of replicas in order to maintain the <em>overall</em> batch size of 128.</p>
<p>We can now write our usual forward-backward-optimize training code, and add a function call to average the gradients of our models. (The following is largely inspired from the official <a href="https://github.com/pytorch/examples/blob/master/mnist/main.py" target="_blank">PyTorch MNIST example</a>.)</p>
<pre><code class="lang-py"><span class="hljs-string">&quot;&quot;&quot; Distributed Synchronous SGD Example &quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span><span class="hljs-params">(rank, size)</span>:</span>
        torch.manual_seed(<span class="hljs-number">1234</span>)
        train_set, bsz = partition_dataset()
        model = Net()
        optimizer = optim.SGD(model.parameters(),
                              lr=<span class="hljs-number">0.01</span>, momentum=<span class="hljs-number">0.5</span>)

        num_batches = ceil(len(train_set.dataset) / float(bsz))
        <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> range(<span class="hljs-number">10</span>):
            epoch_loss = <span class="hljs-number">0.0</span>
            <span class="hljs-keyword">for</span> data, target <span class="hljs-keyword">in</span> train_set:
                data, target = Variable(data), Variable(target)
                optimizer.zero_grad()
                output = model(data)
                loss = F.nll_loss(output, target)
                epoch_loss += loss.data[<span class="hljs-number">0</span>]
                loss.backward()
                average_gradients(model)
                optimizer.step()
            print(<span class="hljs-string">&apos;Rank &apos;</span>, dist.get_rank(), <span class="hljs-string">&apos;, epoch &apos;</span>,
                  epoch, <span class="hljs-string">&apos;: &apos;</span>, epoch_loss / num_batches)
</code></pre>
<p>It remains to implement the <code>average_gradients(model)</code> function, which simply takes in a model and averages its gradients across the whole world.</p>
<pre><code class="lang-py"><span class="hljs-string">&quot;&quot;&quot; Gradient averaging. &quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">average_gradients</span><span class="hljs-params">(model)</span>:</span>
    size = float(dist.get_world_size())
    <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> model.parameters():
        dist.all_reduce(param.grad.data, op=dist.reduce_op.SUM)
        param.grad.data /= size
</code></pre>
<p><em>Et voil&#xE0;</em>! We successfully implemented distributed synchronous SGD and could train any model on a large computer cluster.</p>
<p><strong>Note:</strong> While the last sentence is <em>technically</em> true, there are <a href="http://seba-1511.github.io/dist_blog" target="_blank">a lot more tricks</a> required to implement a production-level implementation of synchronous SGD. Again, use what <a href="https://pytorch.org/docs/master/nn.html#torch.nn.parallel.DistributedDataParallel" target="_blank">has been tested and optimized</a>.</p>
<h3 id="our-own-ring-allreduce">Our Own Ring-Allreduce</h3>
<p>As an additional challenge, imagine that we wanted to implement DeepSpeech&#x2019;s efficient ring allreduce. This is fairly easily implemented using point-to-point collectives.</p>
<pre><code class="lang-py"><span class="hljs-string">&quot;&quot;&quot; Implementation of a ring-reduce with addition. &quot;&quot;&quot;</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">allreduce</span><span class="hljs-params">(send, recv)</span>:</span>
    rank = dist.get_rank()
    size = dist.get_world_size()
    send_buff = th.zeros(send.size())
    recv_buff = th.zeros(send.size())
    accum = th.zeros(send.size())
    accum[:] = send[:]

    left = ((rank - <span class="hljs-number">1</span>) + size) % size
    right = (rank + <span class="hljs-number">1</span>) % size

    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(size - <span class="hljs-number">1</span>):
        <span class="hljs-keyword">if</span> i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:
            <span class="hljs-comment"># Send send_buff</span>
            send_req = dist.isend(send_buff, right)
            dist.recv(recv_buff, left)
            accum[:] += recv[:]
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># Send recv_buff</span>
            send_req = dist.isend(recv_buff, right)
            dist.recv(send_buff, left)
            accum[:] += send[:]
        send_req.wait()
    recv[:] = accum[:]
</code></pre>
<p>In the above script, the <code>allreduce(send, recv)</code> function has a slightly different signature than the ones in PyTorch. It takes a <code>recv</code> tensor and will store the sum of all <code>send</code> tensors in it. As an exercise left to the reader, there is still one difference between our version and the one in DeepSpeech: their implementation divide the gradient tensor into <em>chunks</em>, so as to optimially utilize the communication bandwidth. (Hint: <a href="https://pytorch.org/docs/master/torch.html#torch.chunk" target="_blank">toch.chunk</a>)</p>
<h2 id="advanced-topics">Advanced Topics</h2>
<p>We are now ready to discover some of the more advanced functionalities of <code>torch.distributed</code>. Since there is a lot to cover, this section is divided into two subsections:</p>
<ol>
<li>Communication Backends: where we learn how to use MPI and Gloo for GPU-GPU communication.</li>
<li>Initialization Methods: where we understand how to best setup the initial coordination phase in <code>dist.init_process_group()</code>.</li>
</ol>
<h3 id="communication-backends">Communication Backends</h3>
<p>One of the most elegant aspects of <code>torch.distributed</code> is its ability to abstract and build on top of different backends. As mentioned before, there are currently three backends implemented in PyTorch: TCP, MPI, and Gloo. They each have different specifications and tradeoffs, depending on the desired use-case. A comparative table of supported functions can be found <a href="https://pytorch.org/docs/master/distributed.html#module-torch.distributed" target="_blank">here</a>.</p>
<p><strong>TCP Backend</strong></p>
<p>So far we have made extensive usage of the TCP backend. It is quite handy as a development platform, as it is guaranteed to work on most machines and operating systems. It also supports all point-to-point and collective functions on CPU. However, there is no support for GPUs and its communication routines are not as optimized as the MPI one.</p>
<p><strong>Gloo Backend</strong></p>
<p>The <a href="https://github.com/facebookincubator/gloo" target="_blank">Gloo backend</a> provides an optimized implementation of <em>collective</em> communication procedures, both for CPUs and GPUs. It particularly shines on GPUs as it can perform communication without transferring data to the CPU&#x2019;s memory using <a href="https://developer.nvidia.com/gpudirect" target="_blank">GPUDirect</a>. It is also capable of using <a href="https://github.com/NVIDIA/nccl" target="_blank">NCCL</a> to perform fast intra-node communication and implements its <a href="https://github.com/facebookincubator/gloo/blob/master/docs/algorithms.md" target="_blank">own algorithms</a> for inter-node routines.</p>
<p>Since version 0.2.0, the Gloo backend is automatically included with the pre-compiled binaries of PyTorch. As you have surely noticed, our distributed SGD example does not work if you put <code>model</code> on the GPU. Let&#x2019;s fix it by first replacing <code>backend=&apos;gloo&apos;</code> in <code>init_processes(rank, size, fn, backend=&apos;tcp&apos;)</code>. At this point, the script will still run on CPU but uses the Gloo backend behind the scenes. In order to use multiple GPUs, let us also do the following modifications:</p>
<ol>
<li><code>init_processes(rank, size, fn, backend=&apos;tcp&apos;)</code> <img src="img/tex-0a183ed5142c1166275da8fb1cbbd43f.gif" alt="\rightarrow"> <code>init_processes(rank, size, fn, backend=&apos;gloo&apos;)</code></li>
<li><code>model = Net()</code> <img src="img/tex-0a183ed5142c1166275da8fb1cbbd43f.gif" alt="\rightarrow"> <code>model = Net().cuda(rank)</code></li>
<li><code>data, target = Variable(data), Variable(target)</code> <img src="img/tex-0a183ed5142c1166275da8fb1cbbd43f.gif" alt="\rightarrow"> <code>data, target = Variable(data.cuda(rank)), Variable(target.cuda(rank))</code></li>
</ol>
<p>With the above modifications, our model is now training on two GPUs and you can monitor their utilization with <code>watch nvidia-smi</code>.</p>
<p><strong>MPI Backend</strong></p>
<p>The Message Passing Interface (MPI) is a standardized tool from the field of high-performance computing. It allows to do point-to-point and collective communications and was the main inspiration for the API of <code>torch.distributed</code>. Several implementations of MPI exist (e.g. <a href="https://www.open-mpi.org/" target="_blank">Open-MPI</a>, <a href="http://mvapich.cse.ohio-state.edu/" target="_blank">MVAPICH2</a>, <a href="https://software.intel.com/en-us/intel-mpi-library" target="_blank">Intel MPI</a>) each optimized for different purposes. The advantage of using the MPI backend lies in MPI&#x2019;s wide availability - and high-level of optimization - on large computer clusters. <a href="https://developer.nvidia.com/mvapich" target="_blank">Some</a> <a href="https://developer.nvidia.com/ibm-spectrum-mpi" target="_blank">recent</a> <a href="http://www.open-mpi.org/" target="_blank">implementations</a> are also able to take advantage of CUDA IPC and GPU Direct technologies in order to avoid memory copies through the CPU.</p>
<p>Unfortunately, PyTorch&#x2019;s binaries can not include an MPI implementation and we&#x2019;ll have to recompile it by hand. Fortunately, this process is fairly simple given that upon compilation, PyTorch will look <em>by itself</em> for an available MPI implementation. The following steps install the MPI backend, by installing PyTorch <a href="https://github.com/pytorch/pytorch#from-source" target="_blank">from sources</a>.</p>
<ol>
<li>Create and activate your Anaconda environment, install all the pre-requisites following <a href="https://github.com/pytorch/pytorch#from-source" target="_blank">the guide</a>, but do <strong>not</strong> run <code>python setup.py install</code> yet.</li>
<li>Choose and install your favorite MPI implementation. Note that enabling CUDA-aware MPI might require some additional steps. In our case, we&#x2019;ll stick to Open-MPI <em>without</em> GPU support: <code>conda install -c conda-forge openmpi</code></li>
<li>Now, go to your cloned PyTorch repo and execute <code>python setup.py install</code>.</li>
</ol>
<p>In order to test our newly installed backend, a few modifications are required.</p>
<ol>
<li>Replace the content under <code>if __name__ == &apos;__main__&apos;:</code> with <code>init_processes(0, 0, run, backend=&apos;mpi&apos;)</code>.</li>
<li>Run <code>mpirun -n 4 python myscript.py</code>.</li>
</ol>
<p>The reason for these changes is that MPI needs to create its own environment before spawning the processes. MPI will also spawn its own processes and perform the handshake described in Initialization Methods, making the <code>rank</code>and <code>size</code> arguments of <code>init_process_group</code> superfluous. This is actually quite powerful as you can pass additional arguments to <code>mpirun</code> in order to tailor computational resources for each process. (Things like number of cores per process, hand-assigning machines to specific ranks, and <a href="https://www.open-mpi.org/faq/?category=running#mpirun-hostfile" target="_blank">some more</a>) Doing so, you should obtain the same familiar output as with the other communication backends.</p>
<h3 id="initialization-methods">Initialization Methods</h3>
<p>To finish this tutorial, let&#x2019;s talk about the very first function we called: <code>dist.init_process_group(backend, init_method)</code>. In particular, we will go over the different initialization methods which are responsible for the initial coordination step between each process. Those methods allow you to define how this coordination is done. Depending on your hardware setup, one of these methods should be naturally more suitable than the others. In addition to the following sections, you should also have a look at the <a href="https://pytorch.org/docs/master/distributed.html#initialization" target="_blank">official documentation</a>.</p>
<p>Before diving into the initialization methods, let&#x2019;s have a quick look at what happens behind <code>init_process_group</code> from the C/C++ perspective.</p>
<ol>
<li>First, the arguments are parsed and validated.</li>
<li>The backend is resolved via the <code>name2channel.at()</code> function. A <code>Channel</code> class is returned, and will be used to perform the data transmission.</li>
<li>The GIL is dropped, and <code>THDProcessGroupInit()</code> is called. This instantiates the channel and adds the address of the master node.</li>
<li>The process with rank 0 will execute the <code>master</code> procedure, while all other ranks will be <code>workers</code>.</li>
<li>The master<ol>
<li>Creates sockets for all workers.</li>
<li>Waits for all workers to connect.</li>
<li>Sends them information about the location of the other processes.</li>
</ol>
</li>
<li>Each worker<ol>
<li>Creates a socket to the master.</li>
<li>Sends their own location information.</li>
<li>Receives information about the other workers.</li>
<li>Opens a socket and handshakes with all other workers.</li>
</ol>
</li>
<li>The initialization is done, and everyone is connected to everyone.</li>
</ol>
<p><strong>Environment Variable</strong></p>
<p>We have been using the environment variable initialization method throughout this tutorial. By setting the following four environment variables on all machines, all processes will be able to properly connect to the master, obtain information about the other processes, and finally handshake with them.</p>
<ul>
<li><code>MASTER_PORT</code>: A free port on the machine that will host the process with rank 0.</li>
<li><code>MASTER_ADDR</code>: IP address of the machine that will host the process with rank 0.</li>
<li><code>WORLD_SIZE</code>: The total number of processes, so that the master knows how many workers to wait for.</li>
<li><code>RANK</code>: Rank of each process, so they will know whether it is the master of a worker.</li>
</ul>
<p><strong>Shared File System</strong></p>
<p>The shared filesystem requires all processes to have access to a shared file system, and will coordinate them through a shared file. This means that each process will open the file, write its information, and wait until everybody did so. After what all required information will be readily available to all processes. In order to avoid race conditions, the file system must support locking through <a href="http://man7.org/linux/man-pages/man2/fcntl.2.html" target="_blank">fcntl</a>. Note that you can specify ranks manually or let the processes figure it out by themselves. Be defining a unique <code>groupname</code> per job you can use the same file path for multiple jobs and safely avoid collision.</p>
<pre><code class="lang-py">dist.init_process_group(init_method=<span class="hljs-string">&apos;file:///mnt/nfs/sharedfile&apos;</span>, world_size=<span class="hljs-number">4</span>,
                        group_name=<span class="hljs-string">&apos;mygroup&apos;</span>)
</code></pre>
<p><strong>TCP Init &amp; Multicast</strong></p>
<p>Initializing via TCP can be achieved in two different ways:</p>
<ol>
<li>By providing the IP address of the process with rank 0 and the world size.</li>
<li>By providing <em>any</em> valid IP <a href="https://en.wikipedia.org/wiki/Multicast_address" target="_blank">multicast address</a> and the world size.</li>
</ol>
<p>In the first case, all workers will be able to connect to the process with rank 0 and follow the procedure described above.</p>
<pre><code class="lang-py">dist.init_process_group(init_method=<span class="hljs-string">&apos;tcp://10.1.1.20:23456&apos;</span>, rank=args.rank, world_size=<span class="hljs-number">4</span>)
</code></pre>
<p>In the second case, the multicast address specifies the group of nodes who might potentially be active and the coordination can be handled by allowing each process to have an initial handshake before following the above procedure. In addition TCP multicast initialization also supports a <code>group_name</code> argument (as with the shared file method) allowing multiple jobs to be scheduled on the same cluster.</p>
<pre><code class="lang-py">dist.init_process_group(init_method=<span class="hljs-string">&apos;tcp://[ff15:1e18:5d4c:4cf0:d02d:b659:53ba:b0a7]:23456&apos;</span>,
                        world_size=<span class="hljs-number">4</span>)
</code></pre>
<center>

**Acknowledgements**

</center>

<p>I&#x2019;d like to thank the PyTorch developers for doing such a good job on their implementation, documentation, and tests. When the code was unclear, I could always count on the <a href="https://pytorch.org/docs/master/distributed.html" target="_blank">docs</a> or the <a href="https://github.com/pytorch/pytorch/blob/master/test/test_distributed.py" target="_blank">tests</a> to find an answer. In particular, I&#x2019;d like to thank Soumith Chintala, Adam Paszke, and Natalia Gimelshein for providing insightful comments and answering questions on early drafts.</p>
<p><hr></p>
<div align="center">
    <p><a href="http://www.apachecn.org" target="_blank"><font face="KaiTi" size="6" color="red">&#x6211;&#x4EEC;&#x4E00;&#x76F4;&#x5728;&#x52AA;&#x529B;</font></a></p>
    <p><a href="https://github.com/apachecn/pytorch-doc-zh/" target="_blank">apachecn/pytorch-doc-zh</a></p>
    <p><iframe align="middle" src="https://ghbtns.com/github-btn.html?user=apachecn&amp;repo=pytorch-doc-zh&amp;type=watch&amp;count=true&amp;v=2" frameborder="0" scrolling="0" width="100px" height="25px"></iframe>
    <iframe align="middle" src="https://ghbtns.com/github-btn.html?user=apachecn&amp;repo=pytorch-doc-zh&amp;type=star&amp;count=true" frameborder="0" scrolling="0" width="100px" height="25px"></iframe>
    <iframe align="middle" src="https://ghbtns.com/github-btn.html?user=apachecn&amp;repo=pytorch-doc-zh&amp;type=fork&amp;count=true" frameborder="0" scrolling="0" width="100px" height="25px"></iframe>
    <a target="_blank" href="shang.qq.com/wpa/qunwpa"><img border="0" src="http://data.apachecn.org/img/logo/ApacheCN-group.png" alt="ML | ApacheCN" title="ML | ApacheCN"></a></p>
</div>
 <div style="text-align:center;margin:0 0 10.5px;">
     <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
     <ins class="adsbygoogle" style="display:inline-block;width:728px;height:90px" data-ad-client="ca-pub-3565452474788507" data-ad-slot="2543897000">
     </ins>
     <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>

    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?38525fdac4b5d4403900b943d4e7dd91";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>

    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-102475051-10"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-102475051-10');
    </script>
</div>

<p><meta name="google-site-verification" content="pyo9N70ZWyh8JB43bIu633mhxesJ1IcwWCZlM3jUfFo"></p>
<p><iframe src="https://www.bilibili.com/read/cv2710377" style="display:none"></iframe>
<img src="http://t.cn/AiCoDHwb" hidden="hidden"></p>
<div>
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
    <script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
    <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
    <div id="gitalk-container"></div>
    <script type="text/javascript">
        const gitalk = new Gitalk({
        clientID: '2e62dee5b9896e2eede6',
        clientSecret: 'ca6819a54656af0d87960af15315320f8a628a53',
        repo: 'pytorch-doc-zh',
        owner: 'apachecn',
        admin: ['jiangzhonglian', 'wizardforcel'],
        id: md5(location.pathname),
        distractionFreeMode: false
        })
        gitalk.render('gitalk-container')
    </script>
</div>

<footer class="page-footer"><span class="copyright">Copyright &#xA9; ibooker.org.cn 2019 all right reserved&#xFF0C;&#x7531; ApacheCN &#x56E2;&#x961F;&#x63D0;&#x4F9B;&#x652F;&#x6301;</span><span class="footer-modification">&#x8BE5;&#x6587;&#x4EF6;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A; 
2019-12-27 08:05:23
</span></footer>
<script>console.log("plugin-popup....");document.onclick = function(e){ e.target.tagName === "IMG" && window.open(e.target.src,e.target.src)}</script><style>img{cursor:pointer}</style>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="reinforcement_q_learning.html" class="navigation navigation-prev " aria-label="Previous page: 强化学习（DQN）教程">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="spatial_transformer_tutorial.html" class="navigation navigation-next " aria-label="Next page: 空间转换网络 (Spatial Transformer Networks) 教程">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Writing Distributed Applications with PyTorch","level":"1.2.2.5","depth":3,"next":{"title":"空间转换网络 (Spatial Transformer Networks) 教程","level":"1.2.2.6","depth":3,"path":"spatial_transformer_tutorial.md","ref":"spatial_transformer_tutorial.md","articles":[]},"previous":{"title":"强化学习（DQN）教程","level":"1.2.2.4","depth":3,"path":"reinforcement_q_learning.md","ref":"reinforcement_q_learning.md","articles":[]},"dir":"ltr"},"config":{"plugins":["github","github-buttons","-sharing","insert-logo","sharing-plus","back-to-top-button","code","copy-code-button","mathjax","pageview-count","edit-link","emphasize","alerts","auto-scroll-table","popup","hide-element","page-toc-button","tbfed-pagefooter","sitemap","advanced-emoji","expandable-chapters","splitter","search-pro"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy ibooker.org.cn 2019","modify_label":"该文件修订时间： ","modify_format":"YYYY-MM-DD HH:mm:ss"},"emphasize":{},"github":{"url":"https://github.com/apachecn/pytorch-doc-zh"},"splitter":{},"search-pro":{},"search":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"auto-scroll-table":{},"popup":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"code":{"copyButtons":true},"hide-element":{"elements":[".gitbook-link"]},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"sitemap":{"hostname":"http://pytorch.apachecn.org"},"page-toc-button":{"maxTocDepth":4,"minTocSize":4},"back-to-top-button":{},"pageview-count":{},"alerts":{},"github-buttons":{"buttons":[{"user":"apachecn","repo":"pytorch-doc-zh","type":"star","count":true,"size":"small"}]},"mathjax":{"forceSVG":false,"version":"2.6-latest"},"copy-code-button":{},"advanced-emoji":{"embedEmojis":false},"sharing":{"qq":false,"all":["qq","douban","facebook","google","linkedin","twitter","weibo","whatsapp"],"douban":false,"facebook":false,"weibo":true,"whatsapp":false,"twitter":false,"line":false,"google":false,"qzone":true},"edit-link":{"label":"编辑本页","base":"https://github.com/apachecn/pytorch-doc-zh/blob/master/docs/0.3"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"insert-logo":{"style":"background: none; max-height: 150px; min-height: 150px","url":"http://data.apachecn.org/img/logo.jpg"},"expandable-chapters":{}},"my_links":{"sidebar":{"Home":"https://www.baidu.com"}},"theme":"default","author":"ApacheCN","my_plugins":["donate","todo","-lunr","-search","expandable-chapters-small","chapter-fold","expandable-chapters","expandable-chapters-small","back-to-top-button","ga","baidu","sitemap","tbfed-pagefooter","advanced-emoji","sectionx","page-treeview","simple-page-toc","ancre-navigation","theme-apachecn@git+https://github.com/apachecn/theme-apachecn#HEAD","pagefooter-apachecn@git+https://github.com/apachecn/gitbook-plugin-pagefooter-apachecn#HEAD"],"my_pluginsConfig":{"page-treeview":{"copyright":"Copyright &#169; aleen42","minHeaderCount":"2","minHeaderDeep":"2"},"ignores":["node_modules"],"simple-page-toc":{"maxDepth":3,"skipFirstH1":true},"page-copyright":{"wisdom":"Designer, Frontend Developer & overall web enthusiast","noPowered":false,"copyright":"Copyright &#169; 你的名字","style":"normal","timeColor":"#666","utcOffset":"8","format":"YYYY-MM-dd hh:mm:ss","signature":"你的签名","copyrightColor":"#666","description":"modified at"},"donate":{"wechat":"微信收款的二维码URL","alipay":"支付宝收款的二维码URL","title":"","button":"赏","alipayText":"支付宝打赏","wechatText":"微信打赏"},"page-toc-button":{"maxTocDepth":2,"minTocSize":2},"github-buttons":{"buttons":[{"user":"apachecn","repo":"pytorch-doc-zh","type":"star","count":true,"size":"small"},{"user":"apachecn","width":"160","type":"follow","count":true,"size":"small"}]},"ga":{"token":"UA-102475051-10"},"baidu":{"token":"75439e2cbd22bdd813226000e9dcc12f"},"pagefooter-apachecn":{"copyright":"Copyright &copy ibooker.org.cn 2019","modify_label":"该文件修订时间： ","modify_format":"YYYY-MM-DD HH:mm:ss"}},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Pytorch 中文文档","language":"zh-hans","gitbook":"*","description":"Pytorch 中文文档: 教程和文档"},"file":{"path":"dist_tuto.md","mtime":"2019-12-27T08:05:23.679Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-12-27T08:07:11.023Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-insert-logo/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="https://cdn.mathjax.org/mathjax/2.6-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-pageview-count/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-alerts/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-auto-scroll-table/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-hide-element/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

